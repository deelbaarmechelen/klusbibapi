language: php
php:
- '7.0'
env:
- TEST_DATABASE_URL=mysql://root:@127.0.0.1:3306/klusbibapi JWT_SECRET=dummy
services:
- mysql
before_install:
- openssl aes-256-cbc -K $encrypted_f65dcc8c7326_key -iv $encrypted_f65dcc8c7326_iv
  -in deploy.key.enc -out deploy.key -d
before_script:
- mysql -e "create database IF NOT EXISTS klusbibapi;" -uroot;
- composer install
- vendor/bin/phinx migrate -e ci --verbose
script: vendor/bin/phpunit --verbose --bootstrap tests/bootstrap.php --coverage-text
after_failure:
- cat $HOME/build/renardeau/klusbibapi/tests/logs/app.log
after_success:
  - eval "$(ssh-agent -s)" #start the ssh agent
  - chmod 600 .travis/deploy.key # this key should have push access
  - ssh-add .travis/deploy.key
  - ssh-keyscan klusbib.be >> ~/.ssh/known_hosts
  - git remote add deploy dokku@klusbib.be:api
  - git config --global push.default simple
  - git push deploy master
